name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install pandas numpy scikit-learn xgboost pytest

      - name: Run unit tests
        run: |
          python -m pytest tests/ -v

      - name: Validate Python modules
        run: |
          python -m py_compile api/main.py
          python -m py_compile api/schemas.py
          python -m py_compile api/feature_engine.py
          python -m py_compile api/train_and_export.py
          echo "All Python modules validated successfully"

      - name: Validate SQL notebooks
        run: |
          echo "Checking SQL notebooks..."
          for file in notebooks/sql/*.sql; do
            if [ -f "$file" ]; then
              echo "Found: $file"
              if [ -s "$file" ]; then
                echo "  OK - $file has content"
              else
                echo "  ERROR - $file is empty"
                exit 1
              fi
            fi
          done
          echo "All SQL notebooks validated successfully"

      - name: Validate Python notebooks
        run: |
          echo "Checking Python notebooks..."
          for file in notebooks/python/*.py; do
            if [ -f "$file" ]; then
              echo "Checking $file"
              grep -v "^# MAGIC" "$file" | grep -v "^# COMMAND" | grep -v "^%pip" | grep -v "^%sql" > /tmp/temp_check.py
              python -m py_compile /tmp/temp_check.py
              echo "  OK - $file"
            fi
          done
          echo "All Python notebooks validated successfully"
